name: k6 load tests (manual)

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "Base URL to test (e.g. https://staging-api.example.com)"
        required: true
        type: string
      vus:
        description: "Virtual users (K6_VUS)"
        required: false
        default: "5"
        type: string
      duration:
        description: "Test duration (K6_DURATION, e.g. 30s, 2m)"
        required: false
        default: "30s"
        type: string
      sleep_seconds:
        description: "Sleep between iterations (K6_SLEEP_SECONDS)"
        required: false
        default: "0.2"
        type: string
      search_zip:
        description: "providers/search zip"
        required: false
        default: "10001"
        type: string

permissions:
  contents: read

jobs:
  k6:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: Validate required secrets
        env:
          LOADTEST_CONSUMER_TOKEN: ${{ secrets['LOADTEST_CONSUMER_TOKEN'] }}
          LOADTEST_PROVIDER_TOKEN: ${{ secrets['LOADTEST_PROVIDER_TOKEN'] }}
        run: |
          if [ -z "$LOADTEST_CONSUMER_TOKEN" ]; then
            echo "Missing secret: LOADTEST_CONSUMER_TOKEN" >&2
            exit 1
          fi
          if [ -z "$LOADTEST_PROVIDER_TOKEN" ]; then
            echo "Missing secret: LOADTEST_PROVIDER_TOKEN" >&2
            exit 1
          fi

      - name: Run provider search
        env:
          K6_BASE_URL: ${{ inputs.target_url }}
          K6_AUTH_TOKEN: ${{ secrets['LOADTEST_CONSUMER_TOKEN'] }}
          K6_VUS: ${{ inputs.vus }}
          K6_DURATION: ${{ inputs.duration }}
          K6_SLEEP_SECONDS: ${{ inputs.sleep_seconds }}
          K6_SEARCH_ZIP: ${{ inputs.search_zip }}
        run: k6 run loadtest/provider-search.k6.js

      - name: Run notifications list
        env:
          K6_BASE_URL: ${{ inputs.target_url }}
          K6_AUTH_TOKEN: ${{ secrets['LOADTEST_CONSUMER_TOKEN'] }}
          K6_VUS: ${{ inputs.vus }}
          K6_DURATION: ${{ inputs.duration }}
          K6_SLEEP_SECONDS: ${{ inputs.sleep_seconds }}
        run: k6 run loadtest/notifications-list.k6.js

      - name: Run job post
        env:
          K6_BASE_URL: ${{ inputs.target_url }}
          K6_AUTH_TOKEN: ${{ secrets['LOADTEST_CONSUMER_TOKEN'] }}
          K6_VUS: ${{ inputs.vus }}
          K6_DURATION: ${{ inputs.duration }}
          K6_SLEEP_SECONDS: ${{ inputs.sleep_seconds }}
        run: k6 run loadtest/job-post.k6.js

      - name: Run bid placement
        env:
          K6_BASE_URL: ${{ inputs.target_url }}
          K6_CONSUMER_TOKEN: ${{ secrets['LOADTEST_CONSUMER_TOKEN'] }}
          K6_PROVIDER_TOKEN: ${{ secrets['LOADTEST_PROVIDER_TOKEN'] }}
          K6_VUS: ${{ inputs.vus }}
          K6_DURATION: ${{ inputs.duration }}
          K6_SLEEP_SECONDS: ${{ inputs.sleep_seconds }}
        run: k6 run loadtest/bid-placement.k6.js

      - name: Run message send
        env:
          K6_BASE_URL: ${{ inputs.target_url }}
          K6_CONSUMER_TOKEN: ${{ secrets['LOADTEST_CONSUMER_TOKEN'] }}
          K6_VUS: ${{ inputs.vus }}
          K6_DURATION: ${{ inputs.duration }}
          K6_SLEEP_SECONDS: ${{ inputs.sleep_seconds }}
        run: k6 run loadtest/message-send.k6.js
